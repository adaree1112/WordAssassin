<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Word Assassin Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; transition: background 0.3s, color 0.3s; }
  textarea { width: 100%; height: 120px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; table-layout: fixed; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; width: 33.33%; word-wrap: break-word; }
  th { background: #4CAF50; color: white; }
  td[contenteditable="true"] { background: #f9f9f9; }
  button { margin: 5px; padding: 8px 12px; cursor: pointer; }
  .controls { margin: 10px 0; }

  /* Dark mode styles */
  body.dark-mode { background: #121212; color: #e0e0e0; }
  body.dark-mode th { background: #333; color: #fff; }
  body.dark-mode td { background: #1e1e1e; color: #e0e0e0; border-color: #444; }
  body.dark-mode textarea { background: #1e1e1e; color: #e0e0e0; border: 1px solid #444; }
  body.dark-mode button { background: #333; color: #fff; border: 1px solid #555; }

  /* Dark mode toggle button */
  #darkModeToggle {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background: #4CAF50;
    color: white;
    font-size: 14px;
  }
  body.dark-mode #darkModeToggle {
    background: #666;
    color: #fff;
  }
</style>
</head>
<body>

<button id="darkModeToggle">🌙 Dark Mode</button>

<h2>Word Assassin Generator</h2>

<label>Enter names (one per line, minimum 3, no duplicates):</label><br>
<textarea id="names"></textarea><br><br>

<label><input type="checkbox" id="noWords"> No words (Assassin/Bang Bang You're Dead)</label><br><br>

<div id="difficultyWrapper">
  <label>Select difficulty: </label>
  <select id="difficulty"></select>
</div>

<div class="controls">
  <button onclick="generatePreview()">Generate Preview</button>
  <button onclick="downloadCSV()">Download CSV</button>
  <button onclick="downloadPDF()">Download PDF</button>
  <button onclick="printPDF()">Print</button>
</div>

<h3>Preview (double-click Word to edit):</h3>
<table id="previewTable">
  <thead>
    <tr>
      <th>Task for</th>
      <th>Name</th>
      <th class="wordCol">Word</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let words = {};
let previewData = [];

// Load words.json
fetch("words.json")
  .then(res => res.json())
  .then(data => {
    words = data;
    let diffSelect = document.getElementById("difficulty");
    Object.keys(words).forEach(level => {
      let opt = document.createElement("option");
      opt.value = level;
      opt.textContent = level;
      diffSelect.appendChild(opt);
    });
  });

// Dark mode toggle with persistence
const darkModeToggle = document.getElementById("darkModeToggle");
if (localStorage.getItem("darkMode") === "enabled") {
  document.body.classList.add("dark-mode");
  darkModeToggle.textContent = "☀️ Light Mode";
}

darkModeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("darkMode", "enabled");
    darkModeToggle.textContent = "☀️ Light Mode";
  } else {
    localStorage.setItem("darkMode", "disabled");
    darkModeToggle.textContent = "🌙 Dark Mode";
  }
});

// Rest of your JS (unchanged)...
function getRandomWords(count, difficulty) {
  let pool = [...words[difficulty]];
  if (count > pool.length) {
    alert("Not enough words in " + difficulty + " list.");
    return [];
  }
  let selected = [];
  while (selected.length < count) {
    let idx = Math.floor(Math.random() * pool.length);
    selected.push(pool.splice(idx, 1)[0]); // remove to ensure uniqueness
  }
  return selected;
}

function shuffleNoSelf(names) {
  const n = names.length;
  let shuffled;
  let attempts = 0;
  do {
    shuffled = [...names].sort(() => Math.random() - 0.5);
    attempts++;
    if (attempts > 1000) break;
  } while (shuffled.some((name, i) => name === shuffled[(i-1+n)%n]));
  return shuffled;
}

function buildData() {
  let names = document.getElementById("names").value
    .split("\n")
    .map(n => n.trim())
    .filter(n => n);

  if (names.length < 3) {
    alert("Please enter at least 3 names.");
    return [];
  }

  let nameSet = new Set(names);
  if (nameSet.size !== names.length) {
    alert("Duplicate names detected. Please ensure all names are unique.");
    return [];
  }

  names = shuffleNoSelf(names);
  let noWords = document.getElementById("noWords").checked;

  let randomWords = noWords ? [] : getRandomWords(names.length, document.getElementById("difficulty").value);

  let data = [];
  for (let i = 0; i < names.length; i++) {
    let prev = i === 0 ? names[names.length - 1] : names[i - 1];
    if (noWords) {
      data.push([prev, names[i]]);
    } else {
      data.push([prev, names[i], randomWords[i]]);
    }
  }
  return data;
}

function generatePreview() {
  previewData = buildData();
  renderTable();
}

function renderTable() {
  let tbody = document.querySelector("#previewTable tbody");
  tbody.innerHTML = "";
  let noWords = document.getElementById("noWords").checked;

  // Hide/show header column
  document.querySelectorAll(".wordCol").forEach(col => col.style.display = noWords ? "none" : "");

  previewData.forEach((row, i) => {
    let tr = document.createElement("tr");
    row.forEach((cell, j) => {
      let td = document.createElement("td");
      td.textContent = cell;
      if (!noWords && j === 2) {
        td.contentEditable = "true";
        td.addEventListener("input", () => {
          previewData[i][2] = td.textContent;
        });
      }
      if (noWords && j === 2) td.style.display = "none";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function downloadCSV() {
  let data = previewData.length ? previewData : buildData();
  if (!data.length) return;

  let noWords = document.getElementById("noWords").checked;
  let headers = noWords ? ["Task for","Name"] : ["Task for","Name","Word"];

  let csv = headers.join(",") + "\n" +
    data.map(r => r.join(",")).join("\n");

  let blob = new Blob([csv], { type: "text/csv" });
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "output.csv";
  a.click();
}

function downloadPDF() {
  generatePDF().save("output.pdf");
}

function printPDF() {
  const doc = generatePDF();
  doc.autoPrint();
  const blobURL = doc.output('bloburl');
  const printWindow = window.open(blobURL);
  printWindow.focus();
}

function generatePDF() {
  let data = previewData.length ? previewData : buildData();
  if (!data.length) return;

  let noWords = document.getElementById("noWords").checked;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const margin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();
  const usableWidth = pageWidth - margin * 2;
  const colWidth = usableWidth / (noWords ? 2 : 3);

  doc.autoTable({
    head: [noWords ? ["Task for","Name"] : ["Task for","Name","Word"]],
    body: data,
    startY: margin,
    theme: "grid",
    tableWidth: usableWidth,
    styles: {
      halign: "center",
      valign: "middle",
      fontSize: 10,
      cellPadding: 4,
      overflow: 'linebreak',
      minCellHeight: 0
    },
    columnStyles: noWords ? {
      0: { cellWidth: colWidth },
      1: { cellWidth: colWidth }
    } : {
      0: { cellWidth: colWidth },
      1: { cellWidth: colWidth },
      2: { cellWidth: colWidth }
    },
    headStyles: { fillColor: [128,128,128], textColor: 255, fontStyle: "bold" },
    tableLineWidth: 0.5,
    tableLineColor: [0,0,0],
    margin: { left: margin, right: margin }
  });

  return doc;
}
</script>
</body>
</html>
